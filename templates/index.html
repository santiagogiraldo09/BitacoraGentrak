<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Inspecci贸n de Obra</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    /* Estilos para las tarjetas de 铆tems din谩micos */
    .dynamic-item-box {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 10px;
        background-color: #fcfcfc;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #1CA3EC;
        margin-bottom: 15px;
        padding-bottom: 5px;
    }
    .item-header h3 {
        margin: 0;
        color: #1CA3EC;
    }
    .photo-thumbnail-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 200px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 5px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .thumbnail-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 5px;
    }
</style>
</head>
<body>
    <div id="app">
        <header>
            <div id="logo-container">
                <img src="{{ url_for('static', filename='logo.png') }}" id="logo" alt="Logo">
            </div>
            <h1>Inspecci贸n T茅cnica de Obra</h1>
        </header>

        <input type="hidden" id="project-name">

        <div id="form-container">
            <div id="items-container">
                </div>

            <div class="centrar" style="margin-bottom: 20px;">
                <button type="button" id="add-item-btn" class="activate-camera-button" style="background-color: #28a745;">
                    <i class="fas fa-plus"></i> A帽adir Nuevo tem
                </button>
            </div>
            
            <div class="centrar">
                <button id="activate-camera-btn" class="activate-camera-button">
                    <i class="fas fa-camera"></i> Activar C谩mara para Evidencia
                </button>
            </div>

            <div class="attachment-controls">
                <label>Adjuntar Evidencia desde el dispositivo:</label>
                <div class="button-row">
                    <button id="attach-clip" class="clip-button" onclick="document.getElementById('file-input').click()" title="Adjuntar imagen"></button>
                    <input type="file" id="file-input" class="file-input" accept="image/*" multiple style="display:none;">
                    
                    <button id="attach-video-clip" class="clip-button" onclick="document.getElementById('video-file-input').click()" title="Adjuntar video"></button>
                    <input type="file" id="video-file-input" class="file-input" accept="video/*" style="display:none;">
                </div>
            </div>

            <div id="camera-container" style="display: none;">
                <video id="videoElement" autoplay playsinline muted></video>
                <canvas id="photoCanvas" style="display:none;"></canvas>
            </div>
            
            <div class="action-buttons-wrapper" style="display: none;">
                <div class="button-row">
                    <button id="take-photo" class="round-button" onclick="takePhoto()" title="Tomar Foto">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button id="start-record-btn" class="round-button" title="Grabar Video">
                        <i class="fas fa-video"></i>
                    </button>
                    <button id="stop-record-btn" class="round-button" title="Detener Grabaci贸n">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>
            
            <div id="gallery-container">
                <div id="photoThumbnails" class="photo-thumbnails"></div>
                <div id="videoThumbnails" class="photo-thumbnails"></div>
            </div>
            
            <div class="centrar">
                <button id="save-record" onclick="saveRecord()">Guardar registro</button>
            </div>

            <input type="hidden" id="base64-photo">
            <div id="successMessage" style="display:none;" class="centrar"></div>
            <div id="loading-overlay" class="loading-overlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <template id="inspection-template">
        <div class="dynamic-item-box">
            <div class="item-header">
                <h3 class="item-title">tem #1</h3>
                <button type="button" class="remove-item-btn" style="background:none; border:none; color:red; cursor:pointer; display:none;">
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
            </div>

            <div class="form-group">
                <label>Elemento / rea Inspeccionada:</label>
                <div class="input-with-icon">
                    <input type="text" class="field-elemento">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci贸n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Especificaci贸n T茅cnica (Planos / Memoria):</label>
                <div class="input-with-icon">
                    <input type="text" class="field-especificacion">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci贸n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Condici贸n Observada en Obra:</label>
                <div class="input-with-icon">
                    <input type="text" class="field-condicion">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci贸n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Cumple (S铆/No):</label>
                <div class="input-with-icon">
                    <select class="field-cumple form-input" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                        <option value="">Seleccione...</option>
                        <option value="S铆">S铆</option>
                        <option value="No">No</option>
                        <option value="N/A">N/A</option>
                    </select>
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci贸n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Observaciones:</label>
                <div class="input-with-icon">
                    <input type="text" class="field-observaciones">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci贸n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Acciones Correctivas (si aplica):</label>
                <div class="input-with-icon">
                    <input type="text" class="field-acciones">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci贸n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>
        </div>
    </template>

    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        let itemCount = 0;

        function addItem() {
            itemCount++;
            const container = document.getElementById('items-container');
            const template = document.getElementById('inspection-template');
            const clone = template.content.cloneNode(true);
            const box = clone.querySelector('.dynamic-item-box');
            
            // Actualizar t铆tulo
            box.querySelector('.item-title').innerText = `tem #${itemCount}`;
            
            // Configurar IDs 煤nicos para funciones de voz
            const inputs = box.querySelectorAll('input');
            const buttons = box.querySelectorAll('button');
            
            inputs.forEach((input, index) => {
                const uniqueId = `item_${itemCount}_input_${index}`;
                input.id = uniqueId;
                // Vincular botones de esa fila al input correspondiente
                const recordBtn = input.nextElementSibling;
                const stopBtn = recordBtn.nextElementSibling;
                recordBtn.setAttribute('data-target-input', uniqueId);
                stopBtn.setAttribute('data-target-input', uniqueId);
            });

            // Mostrar bot贸n eliminar si no es el primer 铆tem
            if (itemCount > 1) {
                const removeBtn = box.querySelector('.remove-item-btn');
                removeBtn.style.display = 'block';
                removeBtn.onclick = function() {
                    box.remove();
                    reindexItems();
                };
            }

            container.appendChild(clone);
            
            // Re-vincular eventos de voz a los nuevos botones
            if (typeof setupVoiceButtons === "function") {
                setupVoiceButtons();
            }
        }

        function reindexItems() {
            const boxes = document.querySelectorAll('.dynamic-item-box');
            itemCount = 0;
            boxes.forEach((box) => {
                itemCount++;
                box.querySelector('.item-title').innerText = `tem #${itemCount}`;
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Generar el primer 铆tem por defecto
            addItem();

            document.getElementById('add-item-btn').addEventListener('click', addItem);

            const urlParams = new URLSearchParams(window.location.search);
            const projectName = urlParams.get('project');
            if (projectName) {
                document.getElementById('project-name').value = projectName;
            }
        });
    </script>
</body>
</html>